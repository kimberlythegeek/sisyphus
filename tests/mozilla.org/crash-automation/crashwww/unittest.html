<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Crash Automation Workers</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="stylesheet" href="crash.css" type="text/css">
    <link rel="stylesheet" href="jquery/style/ui.base.css" type="text/css">
    <link rel="stylesheet" href="jquery/style/jquery-ui-1.7.2.custom.css" type="text/css">
    <script src="jquery/jquery-1.3.2.min.js"></script>
    <script src="jquery/jquery-ui-1.7.2.custom.min.js"></script>
    <script src="crash-common.js"></script>
    <script src="workers.js"></script>
    <script>
      var limit = 10;
    
      var db = "/unittest";

      $(document).ready(function() {
          $("#next-link").attr("disabled", "true");
          $("#prev-link").attr("disabled", "true");
          $("#view-select").change(function() { location.href = changeParam(location.href, $(this).val()); });
          $.getJSON(db + "/_all_docs?startkey=%22_design%2F%22&endkey=%22_design0%22&include_docs=true", showViews);
          viewName = getParam(location.href);
          if(viewName)
            getView();
       });

      function getView(options, prev, next) {
        var viewUrl = db + "/_design/unittest/_view/" + encodeURIComponent(viewName) + "?limit=" + (limit + 1);
        if(options)
          viewUrl += urlEncode(options);
        getJSON(viewUrl, function(view) { showDocs(view, prev, next);});
      }

      function getPrev() {
        getView({descending : true, startkey : JSON.stringify(prevStartKey),
                 startkey_docid : prevStartKeyId, skip : 1}, true, false);
      }

      function getNext() {
        getView({descending : false, startkey : JSON.stringify(nextStartKey),
                 startkey_docid : nextStartKeyId, skip : 1}, false, true);
      }

      function showDocs(view, prev, next) {
        if(!view.total_rows) {
          $("#message").text("No documents found for this view");
          $("#page-navigation").hide();
          return;
        }

        var rows = view.rows;
        var hasMore = rows.length > limit;
        var start, end;
        if(prev) {
          rows.reverse();
          start = hasMore ? 1 : 0;
          end = hasMore ? limit + 1 : rows.length;
        } 
        else {
          start = 0;
          end = Math.min(rows.length, limit);
        }
        var list = $("#docs-list");
        list.empty();

/*
        headerHtml = "<tr>";
        for(var prop in rows[0].value) {
          if(/^[^_]/.test(prop))
            headerHtml += "<th>" + prop + "</th>";
        }
        list.append(headerHtml + "</tr>");

        for(var i = start; i < end; i++) {
           var value = rows[i].value;
           var docHtml = "<tr>";
           for(var prop in value)
             if(/^[^_]/.test(prop)) {
               var val = value[prop];
               if(val instanceof Object)
                 val = JSON.stringify(val);
               docHtml += "<td><span class='doc-value'>" + val + "</span></td>";
           }
           docHtml += "</tr>";
           list.append(docHtml);
         } */


        for(var i = start; i < end; i++) {
           var value = rows[i].value;
           var docHtml = "<div class='doc'>";
           for(var prop in value)
             if(/^[^_]/.test(prop)) {
               var val = value[prop];
               if(val instanceof Object)
                 val = JSON.stringify(val);
               if(val)
                 val = cropText(val, 60);
               docHtml += "<span class='doc-pair'><span class='doc-prop'>" + prop +
                          " : </span><span class='doc-value'>" + val + "</span></span>";
           }
           list.append(docHtml + "</div>");
         } 

         var offset = view.offset + 1;
         if(prev)
           offset = view.total_rows - view.offset - limit + 1;
         var upper = Math.min(view.total_rows, offset + limit); 
         $("#page-number").text("docs " + offset + "-" + upper + " of " + view.total_rows);

         // for pagination
         if(next || (prev && hasMore)) {
           $("#prev-link").click(getPrev);
           $("#prev-link").removeClass('ui-state-disabled');
           prevStartKey = rows[start].key;
           prevStartKeyId = rows[start].id;
         }
         else {
           $("#prev-link").unbind("click");
           $("#prev-link").addClass('ui-state-disabled');
         }

         if(prev || hasMore) {
           $("#next-link").click(getNext);
           $("#next-link").removeClass('ui-state-disabled');
           nextStartKey = rows[end - 1].key;
           nextStartKeyId = rows[end - 1].id;
         }
         else {
           $("#next-link").unbind("click");
           $("#next-link").addClass('ui-state-disabled');
         }
      }

      function showViews(resp) {
         var views = [];
         for(var view in resp.rows[0].doc.views)
           views.push(view);
         views.sort();
         
         var currView = getParam(document.location.href);
         for(var i = 0; i < views.length; i++) {
           var optionHtml = "<option value='" + views[i] + "'";
           if(currView == views[i])
             optionHtml += " selected='true'";
           optionHtml += "'>" + views[i] + "</option>";
           $("#view-select").append(optionHtml);
         }
      }
      
    </script>
  </head>
  <body>
    <div id="header">
      <div id="title-header" class="big-title">
        <div id="firefox-header">Firefox</div>
        <div>Valgrind Unit Test Automation</div>
      </div>
      <a href="/_utils/crashes/unittest.html" class="small-section highlight">Views</a>
    </div>
    <div>
    <div id="container">
        <div id="views"><span id="view-text">View:</span><select id="view-select"></select></div>
        <div id="page-navigation">
          <span id="page-number"></span>
          <a id="prev-link" class="ui-state-disabled">Prev</a><a id="next-link" class="ui-helper-disabled">Next</a>
        </div>
        <div id="message"></div>
        <table id="docs-list" cellspacing="0"></table>
      </div>
    </div>
  </body>
</html>
